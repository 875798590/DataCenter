<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="/js/themes/default/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="/js/themes/icon.css"/>
    <link rel="stylesheet" type="text/css" href="/css/demo.css"/>
    <script type="text/javascript" src="/js/jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="/js/jquery.easyui.min.1.2.2.js"></script>
    <script type="text/javascript" src="/js/ace.js"></script>
</head>
<style>
    #editor {
        width: 600px;
        height: 200px;
    }
</style>
<body>
<form id="ff" method="post">
    <table cellpadding="5">
        <tr>
            <td>访问地址:</td>
            <td><input class="easyui-validatebox" type="text" name="uri" id="uri" data-options="required:true"/></td>
        </tr>
        <tr>
            <td>访问方式:</td>
            <td><select id="method" name="method" style="width:200px;">
            </select></td>
        </tr>
        <tr>
            <td>超时时间:</td>
            <td><input class="easyui-validatebox" type="text" name="timeout" id="timeout"/></td>
        </tr>
        <tr>
            <td>版本:</td>
            <td><input class="easyui-validatebox" type="text" name="version" id="version"/></td>
        </tr>
        <tr>
            <td>重试次数:</td>
            <td><input class="easyui-validatebox" type="text" name="retries" id="retries"/></td>
        </tr>
        <tr>
            <td>负载均衡:</td>
            <td><input class="easyui-validatebox" type="text" name="loadbalance" id="loadbalance"/></td>
        </tr>
        <tr>
            <td>代理协议:</td>
            <td><select id="type" name="type" style="width:200px;">
            </select></td>
        </tr>
    </table>
</form>
<form id="dubboDetail" style="display: none">
    <table cellpadding="5">
        <tr>
            <td>应用名称:</td>
            <td><input class="easyui-validatebox" type="text" name="appName" id="appName"
                       data-options="required:true"/> <i style="color: #666666">（非必填）</i></td>
        </tr>
        <tr>
            <td>注册中心:</td>
            <td><input class="easyui-validatebox" type="text" name="regId" id="regId"
                       data-options="required:true"/> <i style="color: #666666">（非必填）</i></td>
        </tr>
        <tr>
            <td>类名称:</td>
            <td><input class="easyui-validatebox" type="text" name="interfaceName" id="interfaceName"
                       data-options="required:true"/></td>
        </tr>
        <tr>
            <td>方法名称:</td>
            <td><input class="easyui-validatebox" type="text" name="method" id="methodName"
                       data-options="required:true"/></td>
        </tr>
        <tr>
            <td>参数:
            <td>
                <div id="editor"></div>
                <div style="margin-left: 10px">
                    <h3>示例：</h3>
                    [<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;{"name":"id" ,"className":"java.lang.Integer","required":"false"}<br/>]
                </div>

            </td>
        </tr>
    </table>

</form>
<form id="httpDetail" style="display: none">
    <h1></h1>
</form>
<a id="btn" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'">提交</a>
</body>
<script type="text/javascript">
    var type;

    $(function () {
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/twilight");
        editor.session.setMode("ace/mode/json");
        $('#method').combobox({
            data: [
                {value: 'GET', label: 'GET'},
                {value: 'POST', label: 'POST'},
                {value: 'PUT', label: 'PUT'},
                {value: 'DELETE', label: 'DELETE'},
            ],
            valueField: 'value',
            textField: 'label',
            onSelect: function (rec) {
            }
        });

        $('#type').combobox({
            data: [
                {value: 'dubbo', label: 'dubbo'},
                {value: 'http', label: 'http'},
            ],
            valueField: 'value',
            textField: 'label',
            onSelect: function (rec) {
                //显示配置页面
                type = rec.value;
                var $dubbo = $("#dubboDetail");
                var $http = $("#httpDetail");
                $dubbo.css("display", "none");
                $http.css("display", "none");
                if (type === "dubbo") {
                    $dubbo.css("display", "block");
                }
                if (type === "http") {
                    alert("暂不支持http");
                    $http.css("display", "block");
                }
                console.log(rec)
            }
        });

        $('#btn').bind('click', function () {
            //判断是否选择了后端协议
            if(!type){
                alert("请选择代理协议！");
                return
            }
            //获取表单中的值，并将其中的值改为对线形式
            var params = transFormData($("#ff").serializeArray());
            var detail;
            //获取对应协议的具体API调用的参数形式
            if (type === "dubbo") {
                detail = $("#dubboDetail").serializeArray();
                var value = editor.getValue();
                if(value && value !== ""){
                    detail.push({name:"dubboParams",value:JSON.parse(value)})
                }
            }
            //将具体的API信息输入到prams中
            params["detail"] = JSON.stringify(transFormData(detail));
            //发送ajax请求后端
            $.ajax({
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                url: '/admin/gateway/api',
                data: JSON.stringify(params),
                success: function (data) {
                    console.log(data)
                }
            });
        });
    });
    function transFormData(data) {
        var obj={};
        data.forEach(function (v) {
            obj[v.name]=v.value;
        });
        return obj;
    }
</script>
</html>